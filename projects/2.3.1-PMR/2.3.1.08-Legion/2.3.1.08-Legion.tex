\subsubsection{\stid{1.08} Legion}

\paragraph{Overview}
This project focuses on the development, hardening and support of the
Legion Programming System (\url{https://legion.stanford.edu}) with a
focus on Exascale platforms and workloads that can benefit from
Legion's features and capabilities.  At a fundamental level, the
project focuses s on the key capabilities (e.g. correctness,
performance, scalability) of an alternative programming model for ECP
that seeks to expose additional levels of parallelism and provide more
flexible data-centric abstractions.  In addition, Legion also enables
a separation of concerns of the implementation of an application from
how it is mapped onto a given system architecture.

Our efforts have been focused on addressing bugs, refactoring the
implementation for improved stability, performance and scaling,
extending support for the selected exascale platforms, and also
expanding the feature set as needed for both application and
platform nuances.

\paragraph{Key Challenges}
As with all new approaches to programming high-performance systems,
there distinct challenge and significant level-of-effort required to
reach a level of stability, capabilities, and performance to
establishing acceptance and a stable user base.  In this regard,
Legion is becoming more widely used outside of ECP for both
machine-learning and data-centric computation within industry (e.g.,
NVIDIA and Facebook).  This growing base is providing both additional
developers and use cases that are helping to stabilize the code as well
as broaden the scope of testing.  ECP efforts using Legion will
benefit from this growth and additional external investments.

We have focused much of our efforts on emerging use cases that are
related to machine learning and data-centric workloads.  These domains
are much easier to have a substantial impact as the application codes
rely on external tools (e.g. TensorFlow, Python, etc.) vs. years of
established code written in MPI and/or OpenMP.  We are already seeing
clear benefits of focusing our efforts in this direction. This has
helped us to increase our overall impact as well focus on areas of
adoption across more specialized application needs in support of
machine learning and other data-centric workloads.

The additional scope of maintaining the FlexFlow framework, discussed
below, represents an additional level of scope that requires efforts
for hardening, expanding the feature set, and porting to the ECP
target platforms.  None of this scope was originally planned at the
outset of ECP. 

\paragraph{Solution Strategy}
As part of a larger collaboration between LANL, Stanford University,
NVIDIA, SLAC, Facebook, MIT, and others this project provides the
overarching implementation of Legion that captures the most stable
(correct, feature complete, and performant) versions of the programming
system for ECP's use.  In addition, we are actively looking for
opportunities to further educate the broader community about Legion
and general advantages of using data-centric and task-based approaches
to programming.

We have continued working with Ristra (AD 2.2.5.01), ExaFEL (AD
2.2.4.05) and the CANDLE project (AD 2.2.4.03) to provide support for
Legion.  For all these efforts we provide support, software releases,
and bug fixes related to both correctness and performance. Our project
includes management of the current repository and quarterly, or more
frequent, releases of Legion to the broader community (e.g. NVIDIA,
Facebook, FlexFlow, etc.).  In addition, we have provided initial
support for AMD and Intel GPUs, and features that support
inter-operation with other languages and programming systems --
e.g. MPI, OpenMP, Kokkos, Fortran, and Python. Finally, we have collaborated
at the lower levels of the software stack with the GASNet-EX effort (part
of ST provided

As part of the focused work with CANDLE, we are providing additional
support with the implementation of the FlexFlow deep-learning
framework that is built on top of Legion.  This framework has proven to
be significantly faster than industry-provided solutions such as TensorFlow
and PyTorch -- providing over a 15x reduction in training time on some of
CANDLE's networks. 

\paragraph{Recent Progress}

We continue to discover and address both performance and scalability
issues in the runtime.  In addition, for use cases within ECP, and
also a growing set of users outside of ECP, we have continued to
identify and address bugs and other issues (e.g. missing features).
The vast majority of these fixes have been released and are part of
the Legion releases in use within ECP.

Additional work, some done in collaboration with the GASNet-Ex team
(part of ST 2.3.1.14), has provided a Legion implementation that
supports AMD's GPU architectures as well as GPU-to-GPU network-based
communications.  In addition, the Kokkos interoperability support in
Legion now also supports AMD's GPU software stack and testing is
underway with the Ristra team for full support on early access
test-beds for AMD-based exascale platforms.  Performance debugging will
be an upcoming activity once appropriate resources are available.

Additional work has been done to support Intel's GPUs and all of
Legion's internal CI tests and small test applications are
successfully and correctly running on early access systems.
Performance debugging will be an upcoming activity once appropriate
resources are available.

We have continued to develop high-level entry points for FlexFlow that
allow it to seamlessly use code from existing learning frameworks (e.g.,
Keras, PyTorch, and ONNX).  We currently have versions of Keras/TensorFlow
networks running correctly and are continuing to make progress on support
for PyTorch and ONNX.   Additional work has been done to improve performance
via exposing new levels of parallelism in training networks as well as
graph-centric optimizations.  Our latest results suggest a 2-3x performance
boost over previous results for one of CANDLE's example learning networks.
Like Legion, we currently use a quarterly set of releases for FlexFlow that
are aligned to leverage features and new capabilities of Legion and the
underlying software components on the target platforms. 

Both FlexFlow and Legion are open source projects and distributed via GitHub:

\begin{itemize}
  \item Legion: \url{https://github.com/StanfordLegion/legion/}
  \item FlexFlow: \url{https://github.com/flexflow/FlexFlow} 
\end{quote}

\paragraph{Next Steps}

Our plans for the next year are to continue focusing on the challenges
presented by obtaining reliable, high performance versions of Legion and
FlexFlow on the upcoming exascale system architectures.  

We will continue to work on the Python interfaces for Legion (an aspect
of growing interest from the ExaFEL project for improved productivity)
and the feature set of FlexFlow requested by CANDLE.  This will include
seeking out and improving our outreach and leveraging new features of
Legion exposed by other non-ECP efforts.  Regular open-source releases of
Legion and FlexFlow will continue, and as we test on the early access
systems we will continue to focus on bug fixes, improving capabilities and 
developer productivity, and addressing performance issues. 




